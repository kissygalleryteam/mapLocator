/*! mapLocator - v1.0 - 2013-09-26 11:14:14 AM
* Copyright (c) 2013 牧云; Licensed  */
KISSY.add("gallery/mapLocator/1.0/index",function(a,b,c){function d(c){if(d.superclass.constructor.call(that,c),!a.isPlainObject(c))throw new Error("\u7f3a\u5c11\u53c2\u6570\u5bf9\u8c61\uff01");if(this.set("config",a.merge({},a.mix(this.get("config"),c,void 0,!0))),!c.mapContainer)throw new Error("\u7f3a\u5c11\u5bb9\u5668");this.set("mapContainer",b.one(c.mapContainer))}var e={dragstart:function(a,b){var c=b.get("map"),d=b.get("infoWindow");c.removeOverlay(d)},dragend:function(a,b){var c=b.get("map"),d=b.get("infoWindow");d.setLatLng(a),b.set("latLng",a),c.addOverlay(d)},click:function(a,b){var c=b.get("map"),d=b.get("infoWindow");c.addOverlay(d)}};return a.extend(d,c,{render:function(b){var c=this;b||!window.AliMap?a.getScript("http://api.ditu.aliyun.com/map.js",function(){c._init()}):c._init()},_init:function(){var a=this,b=this.get("map"),c=a.get("config");b&&b.depose&&a._clear(),b=new AliMap(a.get("mapContainer").getDOMNode(),c.mapConfig),a.set("map",b),a._initMarker(c.markerConfig),a._initInfoWindow(),a.fire("ready")},_initMarker:function(a){var b,c=this;this.get("marker")||(a.icon||(a.icon=AliIcon.getDefault()),b=new AliMarker(new AliLatLng(0,0),a),this.set("marker",b),AliEvent.addListener(b,"dragstart",function(a){c.get("config").markerEventHandlers.dragstart(a,c)}),AliEvent.addListener(b,"dragend",function(a){c.get("config").markerEventHandlers.dragend(a,c)}),AliEvent.addListener(b,"click",function(a){c.get("config").markerEventHandlers.click(a,c)}),AliEvent.addListener(b,"add",function(a){a.set("latLng",this.getLatLng())}))},_initInfoWindow:function(b){var c,d=this;d.get("infoWindow")||(c=new AliInfoWindow,c.setRender(b.renderCls),c.setContent(a.substitue('<div class="{prefixCls}-locator-infowindow-bd">{content}</div>',b)),c.setTitle(a.substitue('<div class="{prefixCls}-locator-infowindow-hd">{title}</div>',b)),c.setOffset(new AliPoint(b.offset[0],b.offset[1])),c.setContentSize(new AliPoint(b.contentSize[0],b.contentSize[1])),AliEvent.addListener(c,"add",function(){var a=d.get("infoWindow");a.moveIntoView()}),d.set("infoWindow",c))},restore:function(){var a=this.get("defaultAddress"),b=this;this.get("geocoder").getLocation(a,function(c){var d=b.get("marker"),e=b.get("infoWindow"),f=b.get("map");b.locateByLatLng(c.latlng.lat(),c.latlng.lng(),a),f.removeOverlay(d),f.removeOverlay(e)})},locateByAddress:function(b,c){var d=this;a.isString(b)&&""!=b&&d._addressToLatLng(b,function(a){d.locateByLatLng(a.latlng.lat(),a.latlng.lng(),c)})},locateByLatLng:function(b,c,d){var e,f=this.get("marker"),g=this.get("infoWindow"),h=this.get("map");a.isNumber(b)&&a.isNumber(c)&&(e=new AliLatLng(b,c),f.setLatLng(e),g.setLatLng(e),h.centerAndZoom(e,15),a.isFunction(d)&&d(),h.addOverlay(f),h.addOverlay(g),this.set("latLng",e))},_addressToLatLng:function(b,c){function d(d){d._getLocation(b,function(b){a.isFunction(c)&&c(b)})}var e,f=this;e=f.get("geocoder"),e?d(e):Jla.require(["Ali.Map.Ajax.Geocoder"],1,function(a){var b=new a;f.set("geocoder",b),d(b)})},_clear:function(){this.get("map").depose(),this.set("marker",null),this.set("infoWindow",null),this.set("map",null)}},{ATTRS:{mapContainer:{value:null},map:{value:null},marker:{value:null},infoWindow:{value:null},latLng:{value:null},address:{value:"",validator:function(b){return a.isString(b)}},config:{value:{lntLng:null,address:"",mapConfig:{initControls:[AliMapScaleControl,AliMapOverviewControl,AliMapKeyboardControl,AliMapMouseWheelControl]},markerConfig:{title:"",draggable:!0},markerEventHandlers:e,infoWindowConfig:{prefixCls:"ks-maplocator-",renderCls:"Ali.Map.Panel.Pointer.RoundRect.Style4",title:"",content:"",contentSize:[200,50],offset:[0,-30]}},validator:function(b){return a.isPlainObject(b)&&a.isPlainObject(b.mapConfig)&&a.isPlainObject(b.markerConfig)&&a.isPlainObject(b.markerConfig)&&a.isPlainObject(b.infoWindowConfig)}},geocoder:{value:null}},markerEventHandlers:e}),d},{requires:["node","base"]});