/*! mapLocator - v1.1 - 2013-11-28 3:22:25 PM
* Copyright (c) 2013 牧云; Licensed  */
KISSY.add("gallery/mapLocator/1.1/index",function(a,b,c){function d(c,e){if(d.superclass.constructor.call(this,e),!c)throw new Error("\u7f3a\u5c11\u5730\u56fe\u5bb9\u5668\uff01");this.set("mapContainer",b.one(c)),a.isPlainObject(e)&&this.set("config",a.merge({},a.mix(this.get("config"),e,void 0,void 0,!0))),this.on("afterLatLngChange",function(a){var b,c=this.get("marker"),e=this.get("infoWindow"),f=this.get("map");b=d.latLngOTC(a.newVal),c.setLatLng(b),e.setLatLng(b),f.setCenter(b),f.addOverlay(c),f.addOverlay(e)})}var e={dragstart:function(a,b){var c=b.get("map"),d=b.get("infoWindow");c.removeOverlay(d)},dragend:function(a,b){var c=b.get("map"),e=b.get("infoWindow");e.setLatLng(a),b.set("latLng",d.latLngCTO(a)),c.addOverlay(e)},click:function(a,b){var c=b.get("map"),d=b.get("infoWindow");c.addOverlay(d)}};return a.extend(d,c,{render:function(b){var c=this;b&&b.cleanCache||!window.AliMap?a.getScript("http://api.ditu.aliyun.com/map.js",function(){c._init(b)}):c._init(b)},_init:function(b){var c=this,e=this.get("map"),f=c.get("config");e&&e.depose&&c._clear(),e=new AliMap(c.get("mapContainer").getDOMNode(),a.mix({initControls:[AliMapScaleControl,AliMapOverviewControl,AliMapKeyboardControl,AliMapMouseWheelControl]},f.mapConfig,void 0,void 0,!0)),c.set("map",e),c._initMarker(f.markerConfig),c._initInfoWindow(f.infoWindowConfig),b&&b.latLng&&b.latLng.lat&&b.latLng.lng?(c.set("latLng",b.latLng),c.fire("ready")):b&&b.address?(c.locateByAddress(b.address),c.fire("ready")):Jla.require("Ali.Map.Mod.IpView",3,function(){},[e,{onChange:function(a){c.set("latLng",d.latLngCTO(a)),c.fire("ready")}}])},_initMarker:function(a){var b,c=this;this.get("marker")||(a.icon||(a.icon=AliIcon.getDefault()),b=new AliMarker(new AliLatLng(0,0),a),this.set("marker",b),AliEvent.addListener(b,"dragstart",function(a){c.get("config").markerEventHandlers.dragstart(a,c)}),AliEvent.addListener(b,"dragend",function(a){c.get("config").markerEventHandlers.dragend(a,c)}),AliEvent.addListener(b,"click",function(a){c.get("config").markerEventHandlers.click(a,c)}),AliEvent.addListener(b,"add",function(){}))},_initInfoWindow:function(b){var c,d=this;d.get("infoWindow")||(c=new AliInfoWindow,c.setRender(b.renderCls),c.setContent(a.substitute('<div class="{prefixCls}-locator-infowindow-bd">{content}</div>',b)),c.setTitle(a.substitute('<div class="{prefixCls}-locator-infowindow-hd">{title}</div>',b)),c.setOffset(new AliPoint(b.offset[0],b.offset[1])),c.setContentSize(new AliPoint(b.contentSize[0],b.contentSize[1])),AliEvent.addListener(c,"add",function(){var a=d.get("infoWindow");a.moveIntoView()}),d.set("infoWindow",c))},locateByAddress:function(b,c){var e=this;a.isString(b)&&""!=b&&e._addressToLatLng(b,function(a){e.set("latLng",d.latLngCTO(a.latlng),c)})},_addressToLatLng:function(b,c){function d(d){d.getLocation(b,function(b){a.isFunction(c)&&c(b)})}var e,f=this;e=f.get("geocoder"),e?d(e):Jla.require(["Ali.Map.Ajax.Geocoder"],1,function(a){var b=new a;f.set("geocoder",b),d(b)})},_clear:function(){this.get("map").depose(),this.set("marker",null),this.set("infoWindow",null),this.set("map",null)}},{ATTRS:{mapContainer:{value:null},map:{value:null},marker:{value:null},infoWindow:{value:null},latLng:{value:null,validator:function(b){return a.isPlainObject(b)&&a.isNumber(b.lat)&&a.isNumber(b.lng)}},config:{value:{mapConfig:{},markerConfig:{title:"",draggable:!0},markerEventHandlers:e,infoWindowConfig:{prefixCls:"ks-maplocator-",renderCls:"Ali.Map.Panel.Pointer.RoundRect.Style4",title:"",content:"",contentSize:[200,50],offset:[0,-30]}},validator:function(b){return a.isPlainObject(b)&&a.isPlainObject(b.mapConfig)&&a.isPlainObject(b.markerConfig)&&a.isPlainObject(b.markerConfig)&&a.isPlainObject(b.infoWindowConfig)}},geocoder:{value:null}},markerEventHandlers:e,latLngCTO:function(a){return{lat:a.lat(),lng:a.lng()}},latLngOTC:function(a){var b;try{b=new AliLatLng(a.lat,a.lng)}catch(c){throw new Error("\u5b9e\u4f8b\u5316AliLatLng\u5bf9\u8c61\u5931\u8d25\uff1a"+c.msg)}return b}}),d},{requires:["node","base"]});